<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Gerenciador de CTOs</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 1rem;
        }
        .container {
            max-width: 1280px;
            margin: auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .section-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-field {
            @apply w-24 text-xs p-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out flex-shrink-0;
            text-align: center;
        }
        .result-field {
            @apply w-24 text-center text-xs p-1 border border-gray-200 rounded-md bg-gray-100 font-semibold text-gray-700 flex-shrink-0;
        }
        .signal-good { @apply bg-green-100 border-green-300 text-green-800; }
        .signal-warn { @apply bg-yellow-100 border-yellow-300 text-yellow-800; }
        .signal-bad { @apply bg-red-100 border-red-300 text-red-800; }
        .tab-button {
            @apply whitespace-nowrap py-3 px-4 font-medium text-lg transition-colors duration-200 border-b-2;
        }
        .tab-button:not(.tab-active) {
            @apply text-gray-500 border-gray-200 hover:text-gray-700 hover:border-gray-300;
        }
        .tab-active {
            @apply text-white rounded-t-lg shadow-md border-transparent;
        }
        #tab-desbalanceada.tab-active {
            background: linear-gradient(to right, #F97316, #EF4444); /* orange-500 to red-600 */
        }
        #tab-balanceada.tab-active {
            background: linear-gradient(to right, #2563EB, #7C3AED); /* blue-600 to violet-600 */
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loss-detail {
            @apply w-24 text-xs text-center text-red-600 font-medium p-1 flex-shrink-0;
        }
        .geo-button {
            @apply mt-2 px-2 py-1 text-xs font-bold rounded-lg shadow-sm transition-colors duration-150;
        }
        .manual-signal-field {
          @apply mt-2 w-full text-center text-xs text-gray-500 italic;
        }
        .printable-only-description {
            display: none;
        }
       
       @media print {
            body > .container > header,
            body .border-b.no-print,
            body .tab-panel:not(.active-for-print),
            body footer {
                display: none;
            }

            body .no-print {
                display: none !important;
            }
            
            body .tab-panel.active-for-print {
                display: block !important;
            }

            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
            .printable-area { box-shadow: none !important; border: none !important; }
            h2 { font-size: 1.25rem; }
            #network-layout-container, #balanced-network-container { gap: 0.5rem; }
            .cto-card-print { width: 240px !important; page-break-inside: avoid; }
            .printable-only-description { display: block; margin-top: 0.5rem; text-align: left; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="text-center mb-8 no-print flex justify-between items-start">
            <div>
                <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-gray-800 text-left">Gerenciador de CTOs</h1>
                <p class="text-lg text-gray-500 mt-2 text-left">Planeje e calcule a potência para redes ópticas balanceadas e desbalanceadas.</p>
            </div>
             <div class="flex items-center gap-4">
                <span id="save-status" class="text-sm font-semibold text-gray-500"></span>
                <div class="relative">
                    <button id="project-menu-button" class="bg-white text-gray-700 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition flex items-center border border-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                        </svg>
                        <span>Projeto</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="project-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20 border">
                        <div class="py-1">
                            <input type="file" id="file-input" class="hidden" accept=".json" onchange="loadProject(event)">
                            <label for="file-input" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                Abrir Projeto
                            </label>
                            <a href="#" onclick="saveProject()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 1a1 1 0 00-1 1v6a1 1 0 102 0V6a1 1 0 00-1-1z" /></svg>
                                Salvar Projeto
                            </a>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="py-1">
                            <a href="#" onclick="printCtoReport()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd" /></svg>
                                Imprimir CTOs
                            </a>
                            <a href="#" onclick="downloadFieldReport()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Relatório de Campo
                            </a>
                            <a href="#" onclick="shareProject()" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>
                                Compartilhar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="section-card mb-8">
            <label for="project-name-input" class="font-bold text-lg text-gray-600 text-center block mb-2">Nome do Projeto</label>
            <input id="project-name-input" oninput="handleProjectNameChange(this.value)" type="text" placeholder="Ex: Expansão Bairro Centro" class="w-full max-w-md mx-auto p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500 block">
        </div>

        <div class="border-b border-gray-200 no-print">
            <nav class="-mb-px flex justify-center space-x-4" aria-label="Tabs">
                <button id="tab-desbalanceada" onclick="switchTab('desbalanceada')" class="tab-button tab-active">Rede Desbalanceada</button>
                <button id="tab-balanceada" onclick="switchTab('balanceada')" class="tab-button">Rede Balanceada</button>
            </nav>
        </div>

        <!-- Painel Rede Desbalanceada -->
        <div id="tab-panel-desbalanceada" class="tab-panel printable-area">
            <div class="section-card">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Parâmetros da Rede Desbalanceada</h2>
                 <div class="max-w-md mx-auto mb-6">
                     <label for="map-link-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                     <div class="flex items-center">
                         <input id="map-link-input-unbalanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                         <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                         </button>
                     </div>
                </div>
                 <div class="max-w-xs mx-auto mb-6">
                    <label for="olt-power-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                    <div class="flex items-center">
                        <input type="text" id="olt-power-input-unbalanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                        <span class="font-semibold text-gray-700 ml-2">dBm</span>
                    </div>
                </div>
                <div id="network-layout-container" class="flex flex-wrap justify-center gap-4">
                    <!-- Cards will be inserted here -->
                </div>
                <div class="flex flex-wrap justify-center mt-6 gap-4">
                    <button onclick="addSpliceBox('unbalanced')" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01M12 6v12" /></svg>
                        + CEO/CDR
                    </button>
                    <button onclick="addCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        + CTO
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Painel Rede Balanceada -->
        <div id="tab-panel-balanceada" class="hidden tab-panel printable-area">
             <div class="section-card">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Parâmetros da Rede Balanceada</h2>
                <div class="max-w-md mx-auto mb-6">
                     <label for="map-link-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                     <div class="flex items-center">
                         <input id="map-link-input-balanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                         <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                         </button>
                     </div>
                </div>
                 <div class="max-w-xs mx-auto mb-6">
                    <label for="olt-power-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                    <div class="flex items-center">
                        <input type="text" id="olt-power-input-balanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                        <span class="font-semibold text-gray-700 ml-2">dBm</span>
                    </div>
                </div>
                <div class="max-w-4xl mx-auto grid grid-cols-1 gap-6 bg-gray-50 p-4 rounded-lg border mb-6">
                    <div class="flex flex-col items-center">
                        <label for="balanced-primary-splitter" class="font-bold text-lg text-gray-600">Splitter Primário (CEOA)</label>
                        <select id="balanced-primary-splitter" onchange="handleBalancedConfigChange('primarySplitter', this.value)" class="mt-1 w-full max-w-xs text-center p-2 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"></select>
                    </div>
                </div>
                 <div id="balanced-network-container" class="flex flex-wrap justify-center gap-4">
                     <!-- Cards will be inserted here -->
                 </div>
                 <div class="flex flex-wrap justify-center mt-6 gap-4">
                     <button onclick="addSpliceBox('balanced')" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01M12 6v12" /></svg>
                        + CEO/CDR
                    </button>
                     <button onclick="addBalancedCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                         + CTO
                     </button>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Modal para Descrição -->
    <div id="description-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-left">
                <h3 class="text-xl font-bold text-gray-800">Descrição do Sinal</h3>
                <div class="mt-4">
                    <label for="signal-description-input" class="block text-sm font-medium text-gray-700">Adicione uma nota sobre o sinal medido:</label>
                    <textarea id="signal-description-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                <button onclick="closeDescriptionModal()" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button onclick="saveDescription()" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Alertas -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 text-left" id="modal-title"></h3>
                <div class="mt-4">
                    <p class="text-md text-gray-600 text-left whitespace-pre-line" id="modal-content"></p>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                <button id="ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>

    <footer class="mt-8 pt-8 border-t border-gray-200 text-center text-gray-600 no-print">
        <div class="max-w-2xl mx-auto">
            <h3 class="text-xl font-bold text-gray-800">Suporte e Contato</h3>
            <p class="mt-4 font-semibold">Para dúvidas ou sugestões, entre em contato:</p>
            <a href="https://wa.me/5575998312170" target="_blank" class="mt-2 inline-flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.152,4.26C8.24,4.26,6.65,5.85,6.65,7.761c0,0.619,0.161,1.196,0.446,1.714L6.92,9.88l-0.565,1.977l2.03-0.555	C8.75,11.536,9.423,11.69,10.152,11.69c1.91,0,3.5-1.59,3.5-3.5S12.062,4.26,10.152,4.26z M15.654,14.188	c-0.326-0.164-1.932-0.951-2.232-1.062s-0.519-0.164-0.739,0.164s-0.843,1.062-1.033,1.282s-0.38,0.246-0.705,0.082	s-1.378-0.506-2.624-1.619s-1.958-2.26-2.193-2.646s-0.246-0.58,0.156-0.744c0.094-0.037,0.203-0.09,0.301-0.136	c0.237-0.113,0.312-0.188,0.402-0.313c0.113-0.15,0.168-0.281,0.249-0.459c0.082-0.178,0.041-0.329-0.021-0.492	c-0.062-0.164-0.657-1.583-0.9-2.166c-0.237-0.564-0.485-0.485-0.657-0.492c-0.164-0.01-0.348-0.01-0.533-0.01	c-0.185,0-0.485,0.082-0.739,0.41s-0.9,0.884-0.9,2.144s0.923,2.481,1.053,2.646s1.82,2.777,4.416,3.91	c2.596,1.133,2.596,0.754,3.056,0.732c0.46-0.021,1.523-0.621,1.739-1.22c0.216-0.598,0.216-1.107,0.156-1.22	C16.151,14.398,15.98,14.352,15.654,14.188z M10.001,0C4.486,0,0,4.486,0,10.001c0,5.514,4.486,10,10.001,10	c5.514,0,10-4.486,10-10.001C20.001,4.486,15.515,0,10.001,0z M10.001,18.13c-4.48,0-8.128-3.649-8.128-8.129	c0-4.48,3.649-8.128,8.128-8.128c4.48,0,8.129,3.649,8.129,8.128C18.13,14.481,14.481,18.13,10.001,18.13z"/></svg>
                Chamar no WhatsApp: +55 75 99831-2170
            </a>
            <p class="mt-6 text-sm text-gray-500">Desenvolvido por Jânio Carlos 10/08/2025</p>
        </div>
    </footer>


    <script>
        // --- Variáveis de Estado Globais ---
        let oltPower = 7.00;
        let projectName = '';
        let googleMapsUrl = '';
        let activeTab = 'desbalanceada';
        let networkSegments = [];
        let balancedConfig = { primarySplitter: '1:8' };
        let balancedNetworkCtos = [];
        const FIBER_LOSS_PER_KM = 0.10;
        const FUSION_SPLICE_LOSS = 0.10;
        let debounceTimer = null;
        let currentCtoInfo = null;
        let saveTimeout;

        const FIBER_COLORS = [
            { name: 'Verde', hex: '#28a745', text: 'white' }, { name: 'Amarelo', hex: '#ffc107', text: 'black' },
            { name: 'Branco', hex: '#ffffff', text: 'black' }, { name: 'Azul', hex: '#007bff', text: 'white' },
            { name: 'Vermelho', hex: '#dc3545', text: 'white' }, { name: 'Violeta', hex: '#6f42c1', text: 'white' },
            { name: 'Marrom', hex: '#a52a2a', text: 'white' }, { name: 'Rosa', hex: '#e83e8c', text: 'white' },
            { name: 'Preto', hex: '#000000', text: 'white' }, { name: 'Cinza', hex: '#6c757d', text: 'white' },
            { name: 'Laranja', hex: '#fd7e14', text: 'white' }, { name: 'Aqua', hex: '#00ffff', text: 'black' }
        ];
    
        const UNBALANCED_CTO_ROWS = [
          { label: 'Sinal Entrada', key: 'sinalEntradaHub', type: 'result' },
          { label: 'Splitter Desb.', key: 'splitterHub', type: 'select_hub' },
          { label: 'Perda Passagem', key: 'perdaPassagemHub', type: 'result_detail' },
          { label: 'Sinal Saída', key: 'sinalSaidaHub', type: 'result' },
          { label: 'Perda Trecho', key: 'perdaTotalTrecho', type: 'result_detail' },
          { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
          { label: 'Sinal Final CTO', key: 'sinalFinalCto', type: 'result_final' },
        ];

        const UNBALANCED_SPLICE_BOX_ROWS = [];
        
        const splitterLosses = { 
          'Ausente': { drop: 0, pass: 0 }, '1:2': { drop: 3.7 }, '1:4': { drop: 7.1 }, '1:8': { drop: 10.5 }, '1:16': { drop: 13.7 }, '1:32': { drop: 17.1 }, '1:64': { drop: 20.4 }, '1:128': { drop: 23.9 }, 
          '1:99': { drop: 21.6, pass: 0.3 }, '2:98': { drop: 18.7, pass: 0.4 }, '3:97': { drop: 16.8, pass: 0.4 }, '4:96': { drop: 14.9, pass: 0.4 }, '5:95': { drop: 14.6, pass: 0.5 }, '7:93': { drop: 13.0, pass: 0.6 }, '9:91': { drop: 11.7, pass: 0.65 }, '10:90': { drop: 11.0, pass: 0.7 }, '15:85': { drop: 9.6,  pass: 1.0 }, '20:80': { drop: 7.9,  pass: 1.4 }, '25:75': { drop: 6.95, pass: 1.7 }, '30:70': { drop: 6.0,  pass: 1.9 }, '35:65': { drop: 5.35, pass: 2.3 }, '40:60': { drop: 4.7,  pass: 2.7 }, '45:55': { drop: 4.15, pass: 3.15 }, '50:50': { drop: 3.7,  pass: 2.5 },
        };
        
        function getSignalColorClass(signal) { if (isNaN(signal) || signal === null) return 'bg-gray-100 border-gray-300 text-gray-500'; if (signal < -22) return 'signal-bad'; if (signal < -19) return 'signal-warn'; return 'signal-good'; }
        
        function getSplitterOptions(type, selectedValue) { 
            let list;
            if (type === 'hub') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass !== undefined);
            } else if (type === 'balanced') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined && k !== 'Ausente');
            } else { // cto
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined || k === 'Ausente');
            }
            return list.map(key => `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${key}</option>`).join('');
        }

        function switchTab(tabName) {
            activeTab = tabName;
            const tabs = ['desbalanceada', 'balanceada'];
            tabs.forEach(tab => {
                document.getElementById(`tab-panel-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });
            document.getElementById(`tab-panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            triggerAutoSave();
        }

        function showModal(title, content) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            if(modal) {
                modalTitle.innerText = title;
                modalContent.innerText = content;
                modal.classList.remove('hidden');

                const okBtn = document.getElementById('ok-btn');
                okBtn.onclick = () => modal.classList.add('hidden');
            }
        }

        function showDescriptionModal(index, networkType) {
            currentCtoInfo = { index, networkType };
            const modal = document.getElementById('description-modal');
            const descriptionInput = document.getElementById('signal-description-input');
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            descriptionInput.value = network[index].description || '';
            modal.classList.remove('hidden');
        }

        function saveDescription() {
            if (currentCtoInfo !== null) {
                const { index, networkType } = currentCtoInfo;
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                network[index].description = document.getElementById('signal-description-input').value;
                if (networkType === 'unbalanced') renderUnbalancedNetwork();
                else renderBalancedNetwork();
                 triggerAutoSave();
            }
            closeDescriptionModal();
        }
        
        function closeDescriptionModal() {
            document.getElementById('description-modal').classList.add('hidden');
        }

        function renderUnbalancedNetwork() {
            const container = document.getElementById('network-layout-container');
            container.innerHTML = ''; 
            let ctoCounter = 0;
            let spliceBoxCounter = 0;
            networkSegments.forEach((segment, index) => {
                let displayIndex;
                if(segment.type === 'splice_box'){
                    spliceBoxCounter++;
                    displayIndex = spliceBoxCounter;
                } else {
                    ctoCounter++;
                    displayIndex = ctoCounter;
                }
                const networkCard = createNetworkCard(segment, index, 'unbalanced', displayIndex);
                container.appendChild(networkCard);
            });
        }
        
        function renderBalancedNetwork() {
            const container = document.getElementById('balanced-network-container');
            container.innerHTML = '';
            document.getElementById('balanced-primary-splitter').innerHTML = getSplitterOptions('balanced', balancedConfig.primarySplitter);
            
            let ctoCounter = 0;
            let spliceBoxCounter = 0;

            balancedNetworkCtos.forEach((item, index) => {
                let displayIndex;
                if (item.type === 'splice_box') {
                    spliceBoxCounter++;
                    displayIndex = spliceBoxCounter;
                } else {
                    ctoCounter++;
                    displayIndex = ctoCounter;
                }
                const card = createNetworkCard(item, index, 'balanced', displayIndex);
                container.appendChild(card);
            });
        }

        function createNetworkCard(data, index, networkType, displayIndex) {
            const isUnbalanced = networkType === 'unbalanced';
            const isSpliceBox = data.type === 'splice_box';
            const geoText = data.geo ? `${data.geo.lat.toFixed(5)}, ${data.geo.lon.toFixed(5)}` : 'N/A';
            const cardIdPrefix = isUnbalanced ? 'U' : 'B';
            
            let title = '';
            const finalIndex = displayIndex || index + 1;

            if (isSpliceBox) {
                title = `CEO/CDR-${String(finalIndex).padStart(2, '0')}`;
            } else if (isUnbalanced) {
                title = `CTO-${String(finalIndex).padStart(2, '0')}`;
            } else { 
                title = `CTO Bal.-${String(finalIndex).padStart(2, '0')}`;
            }

            const selectedColor = FIBER_COLORS[data.colorGroup || 0];
            
            const card = document.createElement('div');
            card.className = "cto-card-print flex flex-col items-center bg-gray-50 rounded-lg shadow-md border p-3";
            card.style.width = "280px";
            
            const removeAction = isUnbalanced ? `removeNetworkSegment(${index})` : `removeBalancedItem(${index})`;

            let cardHtml = `
            <h3 class="relative text-lg font-bold mb-3 px-4 py-1 rounded-full border border-gray-300" 
                 style="background-color:${selectedColor.hex}; color:${selectedColor.text};">
                ${title}
                <button onclick="${removeAction}" title="Remover" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors no-print"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </h3>
            <div class="flex flex-col items-center mb-2 w-full">
                <span class="text-xs font-semibold text-gray-600">Geolocalização:</span>
                <span class="text-xs text-gray-500 mt-1 printable-geo">${geoText}</span>
                <div class="flex gap-1 mt-1">
                    <button onclick="getGeoLocation(${index}, '${networkType}')" class="geo-button bg-blue-500 text-white hover:bg-blue-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> GPS</button>
                    <button onclick="copyGeoLocation(${index}, '${networkType}')" class="geo-button bg-gray-500 text-white hover:bg-gray-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg> Copiar</button>
                    <button onclick="openInGoogleMaps(${index}, '${networkType}')" class="geo-button bg-green-500 text-white hover:bg-green-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg> Mapa</button>
                </div>
                <div class="flex items-center mt-2 w-full">
                    <input id="manual-geo-input-${cardIdPrefix}-${index}" type="text" placeholder="Inserir Coords." class="w-full text-center text-xs p-1 rounded-l-md border-2 border-gray-300 focus:border-indigo-500">
                    <button onclick="saveManualGeo(${index}, '${networkType}')" class="bg-indigo-500 text-white text-xs font-bold p-1.5 rounded-r-md hover:bg-indigo-600 transition">Salvar</button>
                </div>
            </div>
             <div class="flex items-center justify-start w-full mb-1.5 px-2 gap-4">
                <div class="flex items-center">
                    <label class="text-xs font-semibold text-gray-600 mr-1">Dist(m):</label>
                    <input id="cto-${cardIdPrefix}-${index}-distance" type="number" value="${data.distance || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'distance')" class="input-field !w-16" />
                </div>
                <div class="flex items-center">
                    <label class="text-xs font-semibold text-gray-600 mr-1">Fusões:</label>
                    <input id="cto-${cardIdPrefix}-${index}-spliceCount" type="number" value="${data.spliceCount || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'spliceCount')" class="input-field !w-12" />
                </div>
            </div>
            `;
            
            if (isSpliceBox) {
                 cardHtml += `<div id="splice-details-${index}" class="w-full mt-2 pt-2 border-t border-gray-300">
                    <div class="text-xs font-semibold text-gray-600 text-center mb-1">Detalhes da Fusão (Cor a Cor)</div>`;
                (data.spliceDetails || []).forEach((detail, detailIndex) => {
                    const color1 = FIBER_COLORS[detail.color1 || 0];
                    const color2 = FIBER_COLORS[detail.color2 || 0];
                    cardHtml += `
                    <div class="flex items-center justify-between w-full mb-1 px-2 gap-1">
                        <select oninput="handleSpliceDetailChange(event, ${index}, ${detailIndex}, 'color1', '${networkType}')" class="input-field flex-1 font-semibold" style="background-color:${color1.hex}; color:${color1.text}; border-color: #999;">
                            ${FIBER_COLORS.map((c, i) => `<option value="${i}" ${i === (detail.color1 || 0) ? 'selected' : ''} style="background-color:${c.hex}; color:${c.text};">${c.name}</option>`).join('')}
                        </select>
                        <span class="text-xs font-bold">X</span>
                        <select oninput="handleSpliceDetailChange(event, ${index}, ${detailIndex}, 'color2', '${networkType}')" class="input-field flex-1 font-semibold" style="background-color:${color2.hex}; color:${color2.text}; border-color: #999;">
                             ${FIBER_COLORS.map((c, i) => `<option value="${i}" ${i === (detail.color2 || 0) ? 'selected' : ''} style="background-color:${c.hex}; color:${c.text};">${c.name}</option>`).join('')}
                        </select>
                        <button onclick="removeSpliceDetail(${index}, ${detailIndex}, '${networkType}')" class="p-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    `;
                });
                cardHtml += `<button onclick="addSpliceDetail(${index}, '${networkType}')" class="mt-1 w-full text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded-md transition">+ Adicionar Fusão</button></div>`;
            } else {
                cardHtml += `
                <div class="flex items-center w-full mb-1.5 px-2">
                    <label class="flex-1 text-xs font-semibold text-gray-600">Cor da Fibra:</label>
                    <select id="cto-${cardIdPrefix}-${index}-colorGroup" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'colorGroup')" class="input-field font-semibold" style="background-color:${selectedColor.hex}; color:${selectedColor.text}; border-color: #999;">
                        ${FIBER_COLORS.map((color, colorIndex) => `<option value="${colorIndex}" ${colorIndex === (data.colorGroup || 0) ? 'selected' : ''} style="background-color:${color.hex}; color:${color.text};">${colorIndex + 1} - ${color.name}</option>`).join('')}
                    </select>
                </div>`;
            }

            cardHtml += `<div class="w-full">`;
            
            let parameterRows = [];
            if (isUnbalanced) {
                parameterRows = isSpliceBox ? UNBALANCED_SPLICE_BOX_ROWS : UNBALANCED_CTO_ROWS;
            } else { 
                if (!isSpliceBox) {
                    parameterRows = [
                        { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
                        { label: 'Sinal Final CTO', key: 'sinalFinal', type: 'result_final' }
                    ];
                }
            }
            
            parameterRows.forEach(row => {
                const value = data[row.key];
                if (row.type === 'result_final') {
                    const finalSignal = parseFloat(value);
                    const colorClass = getSignalColorClass(finalSignal);
                    cardHtml += `<div class="flex justify-between items-center w-full mb-1.5 px-2"><label class="text-xs font-semibold text-gray-600">${row.label}:</label><div class="px-3 py-1 text-sm font-bold rounded-full ${colorClass}">${value || '---'} dBm</div></div>`;
                } else {
                    cardHtml += `<div class="flex items-center w-full mb-1.5 px-2"><label class="flex-1 text-xs font-semibold text-gray-600">${row.label}:</label>`;
                    switch(row.type) {
                        case 'select_hub': cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterHub')" class="input-field">${getSplitterOptions('hub', data.splitterHub)}</select>`; break;
                        case 'select_cto':
                             const optionsType = isUnbalanced ? 'cto' : 'balanced';
                             cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterCto')" class="input-field">${getSplitterOptions(optionsType, data.splitterCto)}</select>`;
                             break;
                        case 'result': cardHtml += `<input type="text" value="${value || '---'}" readonly class="result-field" />`; break;
                        case 'result_detail': cardHtml += `<div class="loss-detail">${value || '---'}</div>`; break;
                    }
                    cardHtml += `</div>`;
                }
            });
            
            cardHtml += `<div class="mt-2 w-full text-center text-xs text-gray-500 font-bold no-print flex items-center justify-between"><span>Sinal Medido em Campo</span><button onclick="showDescriptionModal(${index}, '${networkType}')" class="p-1 rounded-full text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400" title="Adicionar/Editar Descrição"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button></div><div class="manual-signal-field no-print"><span class="text-xs text-gray-500 italic">${data.description || 'Nenhuma descrição salva.'}</span></div><div class="printable-only-description"><span class="text-xs font-bold text-gray-700">Descrição: </span><span>${data.description || 'N/A'}</span></div></div>`;
            card.innerHTML = cardHtml;
            return card;
        }
    
        function recalculateUnbalanced() {
            let powerForNextSegment = oltPower;
            
            networkSegments.forEach((segment) => {
                const distanceInKm = (segment.distance || 0) / 1000;
                let fusionLoss;

                if (segment.type === 'splice_box') {
                    fusionLoss = (segment.spliceDetails?.length || 0) * FUSION_SPLICE_LOSS;
                } else {
                     fusionLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;
                }
                
                const totalSegmentLoss = (distanceInKm * FIBER_LOSS_PER_KM) + fusionLoss;
                segment.perdaTotalTrecho = totalSegmentLoss.toFixed(2) + ' dB';

                const sinalEntradaHub = powerForNextSegment - totalSegmentLoss;
                segment.sinalEntradaHub = sinalEntradaHub.toFixed(2);
                
                const hubSplitter = splitterLosses[segment.splitterHub] || { drop: 0, pass: 0 };
                const ctoSplitter = splitterLosses[segment.splitterCto] || { drop: 0 };
                
                segment.perdaPassagemHub = (hubSplitter.pass || 0).toFixed(2) + ' dB';
                
                const sinalFinalCto = sinalEntradaHub - hubSplitter.drop - ctoSplitter.drop;

                if (segment.type !== 'splice_box') {
                    segment.sinalFinalCto = (segment.splitterCto === 'Ausente') ? null : sinalFinalCto.toFixed(2);
                } else {
                    segment.sinalFinalCto = null;
                }
                
                const sinalSaidaHub = sinalEntradaHub - hubSplitter.pass;
                segment.sinalSaidaHub = sinalSaidaHub.toFixed(2);
                
                powerForNextSegment = sinalSaidaHub;
            });
            renderUnbalancedNetwork();
        }

        function recalculateBalanced() {
            let powerForChain = oltPower - (splitterLosses[balancedConfig.primarySplitter]?.drop || 0);

            balancedNetworkCtos.forEach(segment => {
                const inputPower = powerForChain;
                const distanceLoss = ((segment.distance || 0) / 1000) * FIBER_LOSS_PER_KM;

                if (segment.type === 'splice_box') {
                    const fusionLoss = (segment.spliceDetails?.length || 0) * FUSION_SPLICE_LOSS;
                    segment.sinalFinal = null; 
                    powerForChain = inputPower - distanceLoss - fusionLoss;
                } else { 
                    const spliceLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;
                    const secondarySplitterLoss = splitterLosses[segment.splitterCto]?.drop || 0;
                    const finalSignal = inputPower - distanceLoss - spliceLoss - secondarySplitterLoss;
                    segment.sinalFinal = finalSignal.toFixed(2);
                    powerForChain = -Infinity;
                }
            });

            renderBalancedNetwork();
        }
    
       function handleProjectNameChange(name) {
            projectName = name.trim();
            document.title = projectName || 'Gerenciador de CTOs';
            document.getElementById('main-title').innerText = projectName ? `Projeto: ${projectName}` : 'Gerenciador de CTOs';
            triggerAutoSave();
        }
    
        function updateUIWithLoadedData() {
            document.getElementById('project-name-input').value = projectName;
            document.getElementById('main-title').innerText = projectName ? `Projeto: ${projectName}` : 'Gerenciador de CTOs';
            document.title = projectName || 'Gerenciador de CTOs';

            document.getElementById('olt-power-input-unbalanced').value = oltPower.toFixed(2);
            document.getElementById('olt-power-input-balanced').value = oltPower.toFixed(2);

            document.getElementById('map-link-input-unbalanced').value = googleMapsUrl;
            document.getElementById('map-link-input-balanced').value = googleMapsUrl;
            
            recalculateUnbalanced();
            recalculateBalanced();
        }
    
        function handleOltPowerChange(inputElement) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const newValue = parseFloat(inputElement.value.replace(',', '.'));
                if (!isNaN(newValue)) {
                    oltPower = newValue;
                    
                    const unbalancedInput = document.getElementById('olt-power-input-unbalanced');
                    const balancedInput = document.getElementById('olt-power-input-balanced');
                    
                    if (inputElement.id === 'olt-power-input-unbalanced') {
                        balancedInput.value = inputElement.value;
                    } else {
                        unbalancedInput.value = inputElement.value;
                    }

                    recalculateUnbalanced();
                    recalculateBalanced();
                    triggerAutoSave();
                }
            }, 500);
        }
    
        function handleCtoDataChange(event, index, networkType, field) {
             const focusedElementId = event.target.id;
             const selectionStart = event.target.selectionStart;
             clearTimeout(debounceTimer);
             debounceTimer = setTimeout(() => {
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                let value = event.target.value;

                if (field === 'distance' || field === 'spliceCount' || field === 'colorGroup') {
                    value = parseFloat(value) || 0;
                }
                 
                if (network[index]) { 
                    network[index][field] = value; 
                }
                
                if (networkType === 'unbalanced' && field === 'splitterCto') {
                    networkSegments[index][field] = value;
                }

                if (networkType === 'unbalanced') recalculateUnbalanced();
                else recalculateBalanced();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    if (focusedElement.setSelectionRange) {
                        focusedElement.setSelectionRange(selectionStart, selectionStart);
                    }
                }
                triggerAutoSave();
             }, 500);
        }

        function handleBalancedConfigChange(field, value) {
            balancedConfig[field] = value;
            recalculateBalanced();
            triggerAutoSave();
        }

        function handleMapLinkChange(inputElement) {
            const url = inputElement.value.trim();
            googleMapsUrl = url;

            const unbalancedInput = document.getElementById('map-link-input-unbalanced');
            const balancedInput = document.getElementById('map-link-input-balanced');
            
            if (inputElement.id === 'map-link-input-unbalanced') {
                balancedInput.value = url;
            } else if (inputElement.id === 'map-link-input-balanced') {
                unbalancedInput.value = url;
            }
            triggerAutoSave();
        }

        function viewProjectMap() {
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                try {
                    new URL(googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                } catch (e) {
                    showModal("URL Inválida", "Por favor, insira um link válido começando com http:// ou https://");
                }
            } else {
                showModal("Nenhum Mapa Definido", "Por favor, insira um link do Google My Maps no campo correspondente.");
            }
        }

        function copyGeoLocation(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const segment = network[index];
            if (segment && segment.geo) {
                const geoString = `${segment.geo.lat}, ${segment.geo.lon}`;
                const textArea = document.createElement("textarea");
                textArea.value = geoString;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal("Coordenadas Copiadas", `O texto "${geoString}" foi copiado para a área de transferência.`);
                } catch (err) {
                    showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas.");
                }
                document.body.removeChild(textArea);
            } else {
                showModal("Geolocalização Ausente", "Primeiro, clique em 'GPS' para capturar as coordenadas.");
            }
        }

       function openInGoogleMaps(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const cto = network[index];
            
            if (!cto.geo) {
                showModal("Geolocalização Ausente", "Por favor, capture as coordenadas GPS ou insira-as manually primeiro.");
                return;
            }
            
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                 const geoString = `${cto.geo.lat.toFixed(5)}, ${cto.geo.lon.toFixed(5)}`;
                 navigator.clipboard.writeText(geoString).then(() => {
                     window.open(googleMapsUrl, '_blank');
                     showModal("Coordenadas Copiadas", `As coordenadas "${geoString}" foram copiadas. Agora, cole-as no seu mapa para adicionar o ponto.`);
                 }, () => {
                     showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas para a área de transferência.");
                 });
            } else {
                 const lat = cto.geo.lat;
                 const lon = cto.geo.lon;
                 const url = `https://www.google.com/maps?q=${lat},${lon}`;
                 window.open(url, '_blank');
            }
        }
    
        function getGeoLocation(index, networkType) {
            if (!navigator.geolocation) {
                showModal("Geolocalização Não Suportada", "O seu navegador não suporta a API de Geolocalização.");
                return;
            }
            
            if (window.isSecureContext === false) {
                 showModal("Conexão Insegura", "O GPS não pode ser ativado em conexões não seguras (HTTP ou local). Por favor, hospede o ficheiro num servidor com HTTPS para usar esta funcionalidade.");
                 return;
            }

            showModal("A obter localização...", "Por favor, aguarde enquanto o GPS está a ser capturado.\n\nPode ser necessário autorizar o acesso à sua localização no navegador.");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    network[index].geo = { lat: lat, lon: lon };
                    showModal("Localização Capturada!", `As coordenadas ${lat.toFixed(5)}, ${lon.toFixed(5)} foram guardadas.`);
                    if (networkType === 'unbalanced') renderUnbalancedNetwork();
                    else renderBalancedNetwork();
                    triggerAutoSave();
                },
                (error) => {
                    let message = "Ocorreu um erro desconhecido.";
                    if (error.code === 1) { // PERMISSION_DENIED
                         message = "A permissão de acesso ao GPS foi negada.\n\nVerifique as permissões do seu navegador para este site. Lembre-se que o GPS só funciona em conexões seguras (HTTPS).";
                    } else if (error.code === 2) { // POSITION_UNAVAILABLE
                         message = "Localização indisponível. Não foi possível obter a sua posição atual.";
                    } else if (error.code === 3) { // TIMEOUT
                         message = "Tempo esgotado ao tentar obter a localização.";
                    }
                    showModal("Erro de Geolocalização", message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function saveManualGeo(index, networkType) {
            const cardIdPrefix = networkType === 'unbalanced' ? 'U' : 'B';
            const input = document.getElementById(`manual-geo-input-${cardIdPrefix}-${index}`);
            const coordsString = input.value.trim();
            if (coordsString) {
                const parts = coordsString.replace(/ /g, '').split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                        network[index].geo = { lat, lon };
                        if (networkType === 'unbalanced') renderUnbalancedNetwork();
                        else renderBalancedNetwork();
                        showModal("Coordenadas Guardadas", `As coordenadas ${lat}, ${lon} foram guardadas com sucesso.`);
                        input.value = '';
                        triggerAutoSave();
                        return;
                    }
                }
            }
            showModal("Formato Inválido", "Por favor, insira as coordenadas no formato 'latitude, longitude'. Ex: -12.345, -39.876");
        }
        
        function addSpliceDetail(segmentIndex, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].type === 'splice_box') {
                if (!network[segmentIndex].spliceDetails) {
                    network[segmentIndex].spliceDetails = [];
                }
                network[segmentIndex].spliceDetails.push({ color1: 0, color2: 0 });
                if (networkType === 'unbalanced') renderUnbalancedNetwork();
                else renderBalancedNetwork();
                triggerAutoSave();
            }
        }

        function removeSpliceDetail(segmentIndex, detailIndex, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].spliceDetails) {
                network[segmentIndex].spliceDetails.splice(detailIndex, 1);
                if (networkType === 'unbalanced') renderUnbalancedNetwork();
                else renderBalancedNetwork();
                triggerAutoSave();
            }
        }

        function handleSpliceDetailChange(event, segmentIndex, detailIndex, colorKey, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].spliceDetails[detailIndex]) {
                network[segmentIndex].spliceDetails[detailIndex][colorKey] = parseInt(event.target.value, 10);
                if (networkType === 'unbalanced') renderUnbalancedNetwork();
                else renderBalancedNetwork();
                triggerAutoSave();
            }
        }

        function addCto() {
            const lastSegment = networkSegments.length > 0 ? networkSegments[networkSegments.length - 1] : { colorGroup: -1 };
            networkSegments.push({
                type: 'cto',
                splitterHub: 'Ausente',
                splitterCto: 'Ausente', 
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: (lastSegment.colorGroup + 1) % 12
            });
            recalculateUnbalanced();
            triggerAutoSave();
        }

        function removeNetworkSegment(index) {
            if (networkSegments.length > 0) {
                networkSegments.splice(index, 1);
                recalculateUnbalanced();
                triggerAutoSave();
            }
        }
        
        function addSpliceBox(networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const lastSegment = network.length > 0 ? network[network.length - 1] : { colorGroup: -1, outgoingColorGroup: 0 };
            const incomingColor = lastSegment.outgoingColorGroup !== undefined ? lastSegment.outgoingColorGroup : (lastSegment.colorGroup + 1) % 12;

            network.push({
                type: 'splice_box',
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: incomingColor,
                outgoingColorGroup: (incomingColor + 1) % 12,
                spliceDetails: []
            });
            
            if(networkType === 'unbalanced') recalculateUnbalanced();
            else recalculateBalanced();
            triggerAutoSave();
        }

        function addBalancedCto() {
            const lastCto = balancedNetworkCtos.length > 0 ? balancedNetworkCtos[balancedNetworkCtos.length - 1] : { colorGroup: -1 };
            const newColorGroup = lastCto ? (lastCto.colorGroup + 1) % 12 : 0;
            balancedNetworkCtos.push({ 
                type: 'cto',
                distance: 0, 
                spliceCount: 0, 
                geo: null, 
                description: '', 
                colorGroup: newColorGroup,
                splitterCto: '1:8'
            });
            recalculateBalanced();
            triggerAutoSave();
        }

        function removeBalancedItem(index) {
            if (balancedNetworkCtos.length > 0) {
                balancedNetworkCtos.splice(index, 1);
                recalculateBalanced();
                triggerAutoSave();
            }
        }

        function printCtoReport() {
            document.body.classList.add('cto-print-mode');
            
            const activePanel = document.getElementById(`tab-panel-${activeTab}`);
            if(activePanel) activePanel.classList.add('active-for-print');

            window.print();
            
            document.body.classList.remove('cto-print-mode');
             if(activePanel) activePanel.classList.remove('active-for-print');
        }

        function downloadFieldReport() {
             const date = new Date().toLocaleDateString('pt-BR');
            let cardsHtml = '';
            let networkTitle = '';
            let ctoCounter = 0;
            let spliceBoxCounter = 0;

            const network = activeTab === 'desbalanceada' ? networkSegments : balancedNetworkCtos;
            networkTitle = activeTab === 'desbalanceada' ? 'Parâmetros da Rede Desbalanceada' : 'Parâmetros da Rede Balanceada';

            network.forEach((segment) => {
                const selectedColor = FIBER_COLORS[segment.colorGroup || 0];
                const geoText = segment.geo ? `${segment.geo.lat.toFixed(5)}, ${segment.geo.lon.toFixed(5)}` : 'N/A';
                const googleMapsLink = segment.geo ? `<a href="https://www.google.com/maps?q=${segment.geo.lat},${segment.geo.lon}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Ver no Mapa</a>` : 'N/A';
                
                if(segment.type === 'splice_box') {
                    spliceBoxCounter++;
                    const title = `CEO/CDR-${String(spliceBoxCounter).padStart(2, '0')}`;
                     cardsHtml += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem;">${title} (${selectedColor.name})</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Distância:</strong> ${segment.distance || 0} m</div>
                                <div><strong>Nº de Fusões:</strong> ${segment.spliceDetails?.length || 0}</div>
                                <div><strong>Geolocalização:</strong> ${geoText} ${googleMapsLink}</div>
                            </div>
                             <div style="margin-top: 1rem;">
                                <strong>Notas de Campo:</strong>
                                <p style="margin-top: 0.25rem; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem;">${segment.description || '________________________________________________'}</p>
                            </div>
                        </div>`;

                } else {
                    ctoCounter++;
                    const title = activeTab === 'desbalanceada' ? `CTO-${String(ctoCounter).padStart(2, '0')}` : `CTO Bal.-${String(ctoCounter).padStart(2, '0')}`;
                    const sinalFinal = activeTab === 'desbalanceada' ? segment.sinalFinalCto : segment.sinalFinal;
                    
                    cardsHtml += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem;">${title} (${selectedColor.name})</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div><strong>Distância:</strong> ${segment.distance || 0} m</div>
                                <div><strong>Nº de Fusões:</strong> ${segment.spliceCount || 0}</div>
                                ${activeTab === 'desbalanceada' ? `<div><strong>Splitter Desb.:</strong> ${segment.splitterHub || 'N/A'}</div>` : `<div><strong>Splitter Primário:</strong> ${balancedConfig.primarySplitter || 'N/A'}</div>`}
                                <div><strong>Splitter CTO:</strong> ${segment.splitterCto || 'N/A'}</div>
                                <div><strong>Sinal Final Estimado:</strong> <span style="font-weight: bold;">${sinalFinal || '---'} dBm</span></div>
                                <div><strong>Sinal Medido:</strong> _________________ dBm</div>
                                <div><strong>Geolocalização:</strong> ${geoText} ${googleMapsLink}</div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <strong>Notas de Campo:</strong>
                                <p style="margin-top: 0.25rem; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem;">${segment.description || '________________________________________________'}</p>
                            </div>
                        </div>`;
                }
            });

            const reportContent = `
            <!DOCTYPE html>
            <html lang="pt-br">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Relatório de Campo</title>
                <style>
                    body { font-family: sans-serif; background-color: #f4f4f9; color: #1f2937; padding: 2rem; }
                    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                    h1, h2 { border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 16px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>Relatório de Campo</h1>
                    <p>Gerado em: ${date}</p>
                    <h2>Configurações Gerais</h2>
                    <p><strong>Potência OLT:</strong> ${oltPower.toFixed(2)} dBm</p>
                    <p><strong>Mapa do Projeto:</strong> ${googleMapsUrl ? `<a href="${googleMapsUrl}" target="_blank">${googleMapsUrl}</a>` : 'N/A'}</p>
                    
                    <h2>${networkTitle}</h2>
                    ${cardsHtml}
                </div>
            </body>
            </html>`;

            const blob = new Blob([reportContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_de_campo_${activeTab}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function shareProject() {
            let message = `*Relatório de Projeto: ${projectName || 'Sem Título'}*\n\n`;
            message += `*Potência OLT:* ${oltPower.toFixed(2)} dBm\n`;
            if (googleMapsUrl) {
                message += `*Link do Mapa:* ${googleMapsUrl}\n`;
            }
            message += `\n`;
            
            let ctoCounter, spliceBoxCounter;

            // Rede Desbalanceada
            message += `--- *REDE DESBALANCEADA* ---\n\n`;
            ctoCounter = 0;
            spliceBoxCounter = 0;
            networkSegments.forEach((segment) => {
                const colorInfo = FIBER_COLORS[segment.colorGroup || 0];
                if (segment.type === 'splice_box') {
                    spliceBoxCounter++;
                    message += `*CEO/CDR-${String(spliceBoxCounter).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceDetails?.length || 0}\n`;
                } else {
                    ctoCounter++;
                    message += `*CTO-${String(ctoCounter).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceCount || 0}\n`;
                    message += `Sinal Entrada: ${segment.sinalEntradaHub} dBm\n`;
                    message += `Splitter Desb.: ${segment.splitterHub}\n`;
                    message += `Sinal Saída: ${segment.sinalSaidaHub} dBm\n`;
                    message += `Splitter CTO: ${segment.splitterCto}\n`;
                    message += `*Sinal Final CTO:* ${segment.sinalFinalCto || '---'} dBm\n`;
                }
                 if (segment.geo) {
                    message += `Geo: ${segment.geo.lat}, ${segment.geo.lon}\n`;
                }
                message += `\n`;
            });


            // Rede Balanceada
            message += `--- *REDE BALANCEADA* ---\n`;
            message += `Splitter Primário: ${balancedConfig.primarySplitter}\n\n`;
            ctoCounter = 0;
            spliceBoxCounter = 0;
            balancedNetworkCtos.forEach((segment) => {
                const colorInfo = FIBER_COLORS[segment.colorGroup || 0];
                if (segment.type === 'splice_box') {
                    spliceBoxCounter++;
                    message += `*CEO/CDR-${String(spliceBoxCounter).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceDetails?.length || 0}\n`;
                } else {
                    ctoCounter++;
                    message += `*CTO Bal.-${String(ctoCounter).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceCount || 0}\n`;
                    message += `Splitter CTO: ${segment.splitterCto}\n`;
                    message += `*Sinal Final Estimado:* ${segment.sinalFinal} dBm\n`;
                }
                 if (segment.geo) {
                    message += `Geo: ${segment.geo.lat}, ${segment.geo.lon}\n`;
                }
                message += `\n`;
            });


            const shareData = { title: `Projeto: ${projectName || 'Gerenciador de CTOs'}`, text: message };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) { console.error('Erro ao compartilhar:', err); }
            } else {
                showModal('Compartilhamento Indisponível', 'O seu navegador não suporta a função de compartilhamento. Pode copiar o texto manualmente.');
            }
        }
        
        function getProjectData() {
            return { 
                version: "2.0", 
                projectName,
                oltPower, 
                googleMapsUrl, 
                networkSegments, 
                balancedConfig, 
                balancedNetworkCtos
            };
        }
        
        function triggerAutoSave() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) statusEl.textContent = 'Salvando...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveState();
                if (statusEl) statusEl.textContent = 'Salvo!';
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 2000);
            }, 1500);
        }

        function saveState() {
            try {
                const projectData = getProjectData();
                localStorage.setItem('gerenciadorCtoState', JSON.stringify(projectData));
            } catch (e) {
                console.error("Erro ao salvar o estado:", e);
                showModal("Erro de Salvamento", "Não foi possível salvar o projeto. O armazenamento pode estar cheio.");
            }
        }
        
        function saveProject() {
            const fileName = projectName || new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            const projectData = getProjectData();

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), {
                href: url,
                download: `${fileName.replace(/[^a-z0-9]/gi, '_') || 'projeto_cto'}.json`
            });
            document.body.appendChild(a).click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showModal("Projeto Baixado", `O backup do projeto "${fileName}" foi baixado com sucesso!`);
        }
    
        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadDataIntoState(data);
                    saveState(); // Salva o novo estado no localStorage
                    showModal("Projeto Carregado", `O projeto "${projectName}" foi carregado com sucesso!`);
                } catch (error) {
                    showModal("Erro ao Carregar", "O arquivo do projeto pode estar corrompido ou em formato inválido.");
                    console.error("Load project error:", error);
                }
            };
            reader.readAsText(file);
        }
        
        function loadDataIntoState(data) {
            projectName = data.projectName || '';
            oltPower = data.oltPower || 7.00;
            googleMapsUrl = data.googleMapsUrl || '';
            
            if (data.networkSegments) {
                data.networkSegments.forEach(segment => {
                    if (!segment.type) segment.type = 'cto';
                    if (segment.type === 'splice_box' && !segment.spliceDetails) segment.spliceDetails = [];
                });
            }
            networkSegments = data.networkSegments || [];
            
            balancedConfig = data.balancedConfig || { primarySplitter: '1:8' };
            if (data.balancedNetworkCtos) {
                data.balancedNetworkCtos.forEach(item => {
                    if (!item.type) item.type = 'cto'; 
                    if (item.type === 'splice_box' && !item.spliceDetails) item.spliceDetails = [];
                });
            }
            balancedNetworkCtos = data.balancedNetworkCtos || [];
            
            updateUIWithLoadedData();
        }

        function loadStateFromStorage() {
            const savedStateJSON = localStorage.getItem('gerenciadorCtoState');
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    loadDataIntoState(savedState);
                } catch(e) {
                    console.error("Erro ao carregar estado do localStorage:", e);
                }
            } else {
                 updateUIWithLoadedData();
            }
        }


        window.onload = function() {
            loadStateFromStorage();
        };

        const menuButton = document.getElementById('project-menu-button');
        const menu = document.getElementById('project-menu');

        menuButton.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });

        window.addEventListener('click', function(e) {
            if (!menuButton.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>


